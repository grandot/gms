<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>古亭附近有哪些店？</title>
</head>
<body>
  <h1>今天古亭附近有哪些店？</h1>
  <button id="btn">送出查詢</button>
  <pre id="results"></pre>
  <div id="map" style="width:100%;height:400px;"></div>

  <script>
    // 1. 等按鈕點擊
    document.getElementById('btn').onclick = async () => {
      // 2. 取得使用者定位
      if (!navigator.geolocation) return alert('不支援定位');
      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        // 3. 呼叫 Supabase Edge Function
        const res = await fetch('https://psygbalodgljzncoqynv.supabase.co/functions/v1/bright-task', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Vercel 会帮你注入 SUPABASE_ANON_KEY
            'Authorization': 'Bearer ' + VERCEL_ENV === 'production'
              ? process.env.SUPABASE_ANON_KEY
              : '' 
          },
          body: JSON.stringify({
            question: '今天古亭附近有哪些店',
            lat, lng
          })
        });
        const places = await res.json();
        document.getElementById('results').textContent = JSON.stringify(places, null, 2);

        // 4. 渲染地圖和標記
        const map = new google.maps.Map(document.getElementById('map'), {
          center: { lat, lng },
          zoom: 15
        });
        places.forEach(p => {
          new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng },
            map, title: p.name
          });
        });
      }, () => alert('取得定位失敗'));
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=你的GMAPS_API_KEY"></script>
</body>
</html>
