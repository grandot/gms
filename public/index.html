<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>今天古亭附近有哪些店？</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0 8px; }
    #map { height: 400px; width: 100%; margin-top: 8px; }
    #list div { margin: 4px 0; }
  </style>
  <!--
    **重點 1**：這支腳本加了 defer，等整個 DOM 都準備好才跑，
    就不會再出現 `Cannot set properties of null` 的錯誤
  -->
  <script type="module" defer>
    document.addEventListener('DOMContentLoaded', async () => {
      // 先抓到畫面上的元素
      const btn  = document.getElementById('btn');
      const list = document.getElementById('list');
      const mapDiv = document.getElementById('map');

      /* ---------- 1. 從自己的 /api/config 取得金鑰 ---------- */
      let CONFIG;
      try {
        CONFIG = await fetch('/api/config').then(r => r.json());
      } catch (err) {
        list.textContent = '讀取 config 失敗：' + err.message;
        return;
      }

      /* ---------- 2. 動態載入 Google Maps SDK ---------- */
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.PUBLIC_GMAPS_API_KEY}&callback=initMap`;
        s.async = true;
        window.initMap = resolve;   // SDK 下載完成後會呼叫 initMap
        s.onerror = reject;
        document.head.appendChild(s);
      });

      /* ---------- 3. 先把地圖畫出來 ---------- */
      const map = new google.maps.Map(mapDiv, {
        center: { lat: 25.026, lng: 121.522 },
        zoom: 14
      });

      /* ---------- 4. 點「送出查詢」時呼叫自己的 /api/bright-task ---------- */
      btn.onclick = async () => {
        btn.disabled = true;
        list.textContent = '查詢中…';
        try {
          const r = await fetch('/api/bright-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              question: '今天古亭附近有哪些店',
              lat: 25.026,
              lng: 121.522
            })
          });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const places = await r.json();

          // 清空舊結果
          list.innerHTML = '';
          mapDiv.querySelectorAll('img[role="presentation"]').forEach(m => m.remove());

          // 把新結果放到清單 & 地圖
          places.forEach(p => {
            const row = document.createElement('div');
            row.textContent = `${p.name} — ${p.address}`;
            list.appendChild(row);

            new google.maps.Marker({
              position: { lat: p.lat, lng: p.lng },
              map,
              title: p.name
            });
          });

        } catch (err) {
          list.textContent = '查詢失敗：' + err.message;
        } finally {
          btn.disabled = false;
        }
      };
    });
  </script>
</head>
<body>
  <h1>今天古亭附近有哪些店？</h1>
  <button id="btn">送出查詢</button>
  <div id="list"></div>
  <div id="map"></div>
</body>
</html>
