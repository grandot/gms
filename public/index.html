<script>
let MAP, CONFIG;

// 1. 先抓 /api/config 取 key
fetch('/api/config')
  .then(res => res.json())
  .then(c => {
    CONFIG = c;

    // 2. 動態載入 Maps
    const s   = document.createElement('script');
    s.src     = `https://maps.googleapis.com/maps/api/js?key=${c.PUBLIC_GMAPS_API_KEY}&callback=initMap`;
    s.async   = true;
    document.head.appendChild(s);
  })
  .catch(console.error);

// 3. 地圖 callback
function initMap () {
  MAP = new google.maps.Map(document.getElementById('map'), {
    center : { lat: 25.026, lng: 121.522 },
    zoom   : 14
  });
}

// 4. 查詢按鈕
document.getElementById('btn').onclick = () => {
  fetch('/api/bright-task', {
    method : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body   : JSON.stringify({
      question: '今天古亭附近有哪些店2',
      lat : 25.026,
      lng : 121.522
    })
  })
  .then(r => r.json())
  .then(showResults)
  .catch(console.error);
};

function showResults(arr) {
  const list = document.getElementById('list');
  list.innerHTML = arr.map(x => `<p>${x.name} — ${x.address}</p>`).join('');

  arr.forEach(x => new google.maps.Marker({
    map: MAP,
    position: { lat: x.lat, lng: x.lng },
    title: x.name
  }));
}
</script>
