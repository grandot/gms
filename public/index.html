<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>今天古亭附近有哪些店？</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #map { width: 100%; height: 400px; margin-top: 20px; }
    #results div { margin: 4px 0; }
  </style>
</head>
<body>
  <h1>今天古亭附近有哪些店？</h1>
  <button id="btn">送出查詢</button>
  <div id="results"></div>
  <div id="map"></div>

  <script>
    // 1) 動態載入 map script 前要先呼叫 /api/config 拿到真正的 KEY
    async function loadMapScript() {
      const res = await fetch('/api/config')
      if (!res.ok) throw new Error('無法取得地圖金鑰')
      const { key } = await res.json()
      return new Promise((resolve, reject) => {
        window.initMap = resolve
        const s = document.createElement('script')
        s.src = `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap&language=zh-TW`
        s.async = true
        s.defer = true
        s.onerror = reject
        document.head.appendChild(s)
      })
    }

    // 2) initMap() 會在上面 script 載入完成後被呼叫
    let map, markers = []
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 25.026, lng: 121.522 },
        zoom: 14,
      })
    }

    // 3) 按鈕綁定事件
    document.getElementById('btn').addEventListener('click', async () => {
      try {
        // 先把地圖載進來
        await loadMapScript()

        // 再呼叫後端 edge function 拿資料
        const resp = await fetch('/api/bright-task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: '今天古亭附近有哪些店',
            lat: 25.026,
            lng: 121.522
          })
        })
        if (!resp.ok) {
          const text = await resp.text()
          throw new Error(text)
        }
        const data = await resp.json()

        // 顯示列表
        document.getElementById('results').innerHTML =
          data.map(d => `<div>• ${d.name} — ${d.address}</div>`).join('')

        // 清除舊的 marker
        markers.forEach(m => m.setMap(null))
        markers = data.map(d => new google.maps.Marker({
          position: { lat: d.lat, lng: d.lng },
          map,
          title: d.name
        }))

      } catch (e) {
        console.error(e)
        alert('發生錯誤：' + e.message)
      }
    })
  </script>
</body>
</html>
